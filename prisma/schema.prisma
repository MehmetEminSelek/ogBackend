// ===================================================================
// ğŸ¯ Ã–MER GÃœLLÃœ SÄ°STEMÄ° - BEST PRACTICE SCHEMA
// CSV Verilerine Uygun TasarÄ±m - 2025
// ===================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================================================
// ğŸ‘¤ USER MANAGEMENT & AUTHENTICATION
// ===================================================================

model User {
  id       Int     @id @default(autoincrement())
  username String  @unique
  email    String? @unique
  password String

  // Unique Personel ID - DEÄÄ°ÅTÄ°RÄ°LEMEZ!
  personelId String @unique // P001, P002, P003... (CSV'den veya otomatik)

  // Profile Info  
  ad      String
  soyad   String?
  telefon String?

  // Work Info
  subeId      Int?
  sube        Sube?       @relation(fields: [subeId], references: [id])
  rol         PersonelRol @default(PERSONEL)
  gunlukUcret Float?      @default(0)
  sgkDurumu   SgkDurumu   @default(YOK)
  girisYili   DateTime?   @db.Date
  aktif       Boolean     @default(true)
  erpDurum    ErpDurum    @default(AKTIF)

  // Relations
  olusturduguSiparisler           Siparis[]      @relation("SiparisOlusturan")
  onayladigiSiparisler            Siparis[]      @relation("SiparisOnaylayan")
  stokHareketleri                 StokHareket[]
  olusturduguStokTransferleri     StokTransfer[] @relation("StokTransferOlusturan")
  gonderdigiStokTransferleri      StokTransfer[] @relation("StokTransferGonderen")
  teslimAldÄ±ÄŸÄ±StokTransferleri StokTransfer[] @relation("StokTransferTeslimAlan")
  cariOdemeler                    CariOdeme[]
  cariHareketler                  CariHareket[]

  // Audit Relations - KÄ°M NEYÄ° DEÄÄ°ÅTÄ°RDÄ° TAKÄ°BÄ°
  auditLogs            AuditLog[] @relation("PersonelAuditLogs")
  siparisLastModified  Siparis[]  @relation("SiparisLastModifiedBy")
  urunLastModified     Urun[]     @relation("UrunLastModifiedBy")
  cariLastModified     Cari[]     @relation("CariLastModifiedBy")
  materialLastModified Material[] @relation("MaterialLastModifiedBy")
  recipeLastModified   Recipe[]   @relation("RecipeLastModifiedBy")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subeId])
  @@index([rol])
  @@index([aktif])
}

enum PersonelRol {
  GENEL_MUDUR
  SUBE_MUDURU
  URETIM_MUDURU
  SEVKIYAT_MUDURU
  CEP_DEPO_MUDURU
  SUBE_PERSONELI
  URETIM_PERSONEL
  SEVKIYAT_PERSONELI
  SOFOR
  PERSONEL
}

enum SgkDurumu {
  VAR
  YOK
}

enum ErpDurum {
  AKTIF
  PASIF
}

// ===================================================================
// ğŸ¢ BRANCH & LOCATION MANAGEMENT
// ===================================================================

model Sube {
  id  Int      @id @default(autoincrement())
  ad  String   @unique
  kod String   @unique // SB001, SB002, OP001, vb.
  tip SubeTipi @default(SATIS_SUBESI)

  // Contact Info
  adres   String?
  telefon String?
  email   String?
  sorumlu String?

  // Operational Info
  aktif       Boolean @default(true)
  acilisSaat  String? // "08:00"
  kapanisSaat String? // "22:00"

  // Relations
  personeller         User[]
  siparisler          Siparis[]
  hedefSiparisler     Siparis[]      @relation("HedefSube")
  neredenSiparisler   Siparis[]      @relation("SubeNereden")   // Åubeden ÅŸubeye sipariÅŸlerde nereden
  nereyeSiparisler    Siparis[]      @relation("SubeNereye")    // Åubeden ÅŸubeye sipariÅŸlerde nereye
  kaynakTransferler   StokTransfer[] @relation("KaynakSube")
  hedefTransferler    StokTransfer[] @relation("HedefSube")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kod])
  @@index([tip])
  @@index([aktif])
}

enum SubeTipi {
  SATIS_SUBESI
  OPERASYON_BIRIMI
  URETIM_MERKEZI
  DEPO
}

// ===================================================================
// ğŸ·ï¸ PRODUCT MANAGEMENT (CSV Based)
// ===================================================================

model UrunKategori {
  id       Int     @id @default(autoincrement())
  ad       String  @unique
  kod      String  @unique
  aciklama String?
  aktif    Boolean @default(true)

  // Relations
  urunler Urun[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([aktif])
}

model Urun {
  id  Int    @id @default(autoincrement())
  ad  String @unique
  kod String @unique // UR001, UR002, vb. (CSV'den)

  // Basic Info
  kategoriId Int?
  kategori   UrunKategori? @relation(fields: [kategoriId], references: [id])
  aciklama   String?

  // Fiyat iliÅŸkisi - SABIT FÄ°YAT KALDIRILDI!
  fiyatlar         UrunFiyat[]     // TÃ¼m tarihsel fiyatlar
  
  // GÃ¼ncel fiyat iÃ§in computed field kullanÄ±lacak
  // getCurrentPrice(tarih?: Date) function ile alÄ±nacak
  
  // Status
  aktif       Boolean @default(true)
  satisaUygun Boolean @default(true)

  // Inventory Info
  mevcutStok    Float       @default(0)
  minStokSeviye Float       @default(0)
  birim         SatisBirimi @default(KG)

  // Production Info - Bu alanlar maliyet hesaplama iÃ§in Ã–NEMLÄ°
  maliyetFiyati    Float?    @default(0) // Hesaplanan maliyet
  karMarji         Float?    @default(0) // Kar marjÄ± (GÃ¼ncel Fiyat - Maliyet)
  karOrani         Float?    @default(0) // Kar oranÄ± %
  guncellemeTarihi DateTime? // Maliyet gÃ¼ncellenme tarihi

  // Relations
  receteler        Recipe[]
  siparisKalemleri SiparisKalemi[]
  stokHareketleri  StokHareket[]
  stokTransferleri StokTransfer[]  @relation("UrunTransfer")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?
  updatedBy Int?

  // PERSONEL TAKÄ°P SÄ°STEMÄ° - YENÄ°!
  lastModifiedBy       String? // Son deÄŸiÅŸtiren personelin ID'si
  lastModifiedPersonel User?     @relation("UrunLastModifiedBy", fields: [lastModifiedBy], references: [personelId])
  lastModifiedAt       DateTime? // Son deÄŸiÅŸiklik tarihi
  lastAction           String? // Son yapÄ±lan iÅŸlem ("FÄ°YAT_GÃœNCELLENDÄ°", "STK_DEÄÄ°ÅTÄ°", vb.)

  @@index([kategoriId])
  @@index([kod])
  @@index([aktif])
  @@index([satisaUygun])
}

enum SatisBirimi {
  KG
  GRAM
  ADET
  PAKET
  KUTU
  TEPSI
  LITRE
  ML
}

// ===================================================================
// ğŸ’° YENÄ° FÄ°YATLANDIRMA SÄ°STEMÄ° - TARÄ°HSEL TAKÄ°P
// ===================================================================

// ÃœrÃ¼n FiyatlarÄ± - Tarihsel Takip ile
model UrunFiyat {
  id     Int  @id @default(autoincrement())
  urunId Int
  urun   Urun @relation(fields: [urunId], references: [id], onDelete: Cascade)

  // Fiyat Bilgileri
  kgFiyati     Float        // CSV'deki KG FÄ°YATI
  birim        SatisBirimi  @default(KG)
  fiyatTipi    FiyatTipi    @default(NORMAL)

  // TARÄ°HSEL TAKÄ°P - Ã‡OK Ã–NEMLÄ°!
  baslangicTarihi DateTime   @db.Date  // Bu fiyatÄ±n geÃ§erli olduÄŸu baÅŸlangÄ±Ã§ tarihi
  bitisTarihi     DateTime?  @db.Date  // Bu fiyatÄ±n geÃ§ersiz olduÄŸu tarih (NULL = hala geÃ§erli)
  
  // Durum KontrolÃ¼
  aktif        Boolean      @default(true)

  // Kim Ne Zaman Ekledi/DeÄŸiÅŸtirdi
  createdAt    DateTime     @default(now())
  createdBy    String?      // Personel ID'si
  updatedAt    DateTime     @updatedAt
  updatedBy    String?      // Son gÃ¼ncelleyen personel ID'si
  
  // Zam/Ä°ndirim Sebepleri
  degisiklikSebebi String?   // "GENEL ZAM", "MALZEME ZAMMI", "KAMPANYA" vb.
  eskiFiyat        Float?    // Ã–nceki fiyat (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
  yuzdelik         Float?    // DeÄŸiÅŸim yÃ¼zdesi

  @@unique([urunId, baslangicTarihi, fiyatTipi])
  @@index([aktif])
  @@index([baslangicTarihi])
  @@index([bitisTarihi])
}

// Tepsi/Tava FiyatlarÄ± - AyrÄ± Sistem
model TepsiFiyat {
  id           Int        @id @default(autoincrement())
  tepsiTavaId  Int
  tepsiTava    TepsiTava  @relation(fields: [tepsiTavaId], references: [id], onDelete: Cascade)

  // Fiyat Bilgileri
  adetFiyati      Float        // CSV'deki Adet FiyatÄ±
  fiyatTipi       FiyatTipi    @default(NORMAL)
  
  // TARÄ°HSEL TAKÄ°P
  baslangicTarihi DateTime     @db.Date
  bitisTarihi     DateTime?    @db.Date
  
  // Durum KontrolÃ¼
  aktif           Boolean      @default(true)
  
  // Kim Ne Zaman
  createdAt       DateTime     @default(now())
  createdBy       String?
  updatedAt       DateTime     @updatedAt
  updatedBy       String?
  
  // DeÄŸiÅŸiklik Takibi
  degisiklikSebebi String?
  eskiFiyat        Float?
  yuzdelik         Float?
  
  @@unique([tepsiTavaId, baslangicTarihi, fiyatTipi])
  @@index([aktif])
  @@index([baslangicTarihi])
}

enum FiyatTipi {
  NORMAL
  KAMPANYA
  TOPTAN
  PERAKENDE
  OZEL_FIYAT
  PROMOSYON
  INDIRIMLI
}

// ===================================================================
// ğŸ“¦ PACKAGING MANAGEMENT (CSV Based)
// ===================================================================



model TepsiTava {
  id       Int     @id @default(autoincrement())
  ad       String  @unique
  kod      String  @unique // TP001, TP002, vb. (CSV'den)
  aciklama String?
  
  // Fiyat iliÅŸkisi - SABIT FÄ°YAT KALDIRILDI!
  fiyatlar         TepsiFiyat[]    // TÃ¼m tarihsel fiyatlar
  
  // Fiziksel Ã–zellikler
  agirlik  Float? // gram
  boyut    String? // "1 Li", "2 Li", vb.
  malzeme  String? // Aluminum, Plastic
  aktif    Boolean @default(true)

  // Relations
  siparisKalemleri SiparisKalemi[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kod])
  @@index([aktif])
}

model Kutu {
  id       Int     @id @default(autoincrement())
  ad       String  @unique
  kod      String  @unique // KT001, KT002, vb. (CSV'den)
  aciklama String?
  fiyat    Float?  @default(0)
  agirlik  Float? // gram
  boyutlar Json? // {en, boy, yukseklik}
  aktif    Boolean @default(true)

  // Relations
  siparisKalemleri SiparisKalemi[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kod])
  @@index([aktif])
}

// ===================================================================
// ğŸ‘¥ CUSTOMER MANAGEMENT (CSV Based)
// ===================================================================

model Cari {
  id          Int     @id @default(autoincrement())
  ad          String
  soyad       String?
  musteriKodu String  @unique // MS000001, MS000002, vb. (CSV'den)

  // Contact Info
  telefon   String?
  email     String?
  adres     String? // Ana adres (backward compatibility iÃ§in)
  il        String?
  ilce      String?
  postaKodu String?

  // Business Info
  cariGrubu  String? // CSV'den
  fiyatGrubu String? // CSV'den
  irtibatAdi String? // CSV'den
  subeAdi    String? // CSV'den

  // Account Info
  tipi         CariTipi @default(MUSTERI)
  vergiNo      String?
  vergiDairesi String?

  // Financial Info
  krediLimiti Float? @default(0)
  riskLimiti  Float? @default(0)
  bakiye      Float  @default(0)

  // Status
  aktif Boolean @default(true)

  // Relations
  siparisler Siparis[]
  hareketler CariHareket[]
  odemeler   CariOdeme[]
  adresler   CariAdres[] // YENÄ°: Ã‡oklu adres desteÄŸi
  
  // CSV'den gelen mÃ¼ÅŸteri verileri ile iliÅŸki
  cariMusteriRelation CariMusteriRelation?
  cariMusteriler CariMusteri[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // PERSONEL TAKÄ°P SÄ°STEMÄ° - YENÄ°!
  lastModifiedBy       String? // Son deÄŸiÅŸtiren personelin ID'si
  lastModifiedPersonel User?     @relation("CariLastModifiedBy", fields: [lastModifiedBy], references: [personelId])
  lastModifiedAt       DateTime? // Son deÄŸiÅŸiklik tarihi
  lastAction           String? // Son yapÄ±lan iÅŸlem ("BÄ°LGÄ°_GÃœNCELLENDÄ°", "KREDÄ°_LÄ°MÄ°TÄ°_DEÄÄ°ÅTÄ°", vb.)

  @@index([musteriKodu])
  @@index([tipi])
  @@index([aktif])
}

// YENÄ° MODEL: Cari Adres YÃ¶netimi
model CariAdres {
  id     Int  @id @default(autoincrement())
  cariId Int
  cari   Cari @relation(fields: [cariId], references: [id], onDelete: Cascade)

  // Adres Bilgileri
  tip          AdresTipi @default(DIGER)
  adres        String
  il           String?
  ilce         String?
  mahalle      String?
  postaKodu    String?
  tarif        String? // Ek aÃ§Ä±klama/tarif

  // Durum
  varsayilan   Boolean @default(false) // Ana adres mi?
  aktif        Boolean @default(true)

  // Audit
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([cariId])
  @@index([tip])
  @@index([varsayilan])
}

enum AdresTipi {
  EV
  IS
  DIGER
}

enum CariTipi {
  MUSTERI
  TEDARIKCI
  PERSONEL
  BANKA
  KASA
}

// CSV'den gelen Cari MÃ¼ÅŸteri verileri iÃ§in ayrÄ± model
model CariMusteri {
  id          Int     @id @default(autoincrement())
  cariAdi     String  // "CARÄ° ADI" sÃ¼tunu
  musteriKodu String  @unique // "MÃœÅTERÄ° KODU" sÃ¼tunu
  
  // CSV'den gelen ek bilgiler
  subeAdi     String? // "ÅUBE ADI" sÃ¼tunu (SALON, Ä°BRAHÄ°MLÄ°, OTOGAR, HÄ°TÄ°T, ESKÄ° OTOGAR)
  telefon     String? // "TEL" sÃ¼tunu  
  irtibatAdi  String? // "Ä°RTÄ°BAT ADI" sÃ¼tunu
  cariGrubu   String? // "CARÄ° GRUBU" sÃ¼tunu
  fiyatGrubu  String? // "FÄ°YAT GRUBU" sÃ¼tunu
  
  // Durum
  aktif       Boolean @default(true)
  
  // Ä°lerleyen sÃ¼reÃ§te ana Cari tablosu ile iliÅŸki kurulabilir
  cariId      Int?    // Ana Cari kaydÄ± ile eÅŸleÅŸtirme iÃ§in
  cari        Cari?   @relation(fields: [cariId], references: [id])
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([musteriKodu])
  @@index([subeAdi])
  @@index([aktif])
}

// Ana Cari modeline CariMusteri relation ekliyoruz
model CariMusteriRelation {
  id     Int    @id @default(autoincrement())
  cariId Int    @unique
  cari   Cari   @relation(fields: [cariId], references: [id], onDelete: Cascade)
}

// ===================================================================
// ğŸ“‹ ORDER MANAGEMENT (Best Practice)
// ===================================================================

model TeslimatTuru {
  id              Int     @id @default(autoincrement())
  ad              String  @unique
  kod             String  @unique // TT001, TT002, vb. (CSV'den)
  aciklama        String?
  varsayilanKargo Float?  @default(0)
  aktif           Boolean @default(true)

  // Relations
  siparisler Siparis[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kod])
  @@index([aktif])
}

model Siparis {
  id        Int    @id @default(autoincrement())
  siparisNo String @unique @default(uuid())

  // Date Info
  tarih        DateTime  @db.Date
  teslimTarihi DateTime? @db.Date

  // Customer Info  
  cariId Int?
  cari   Cari? @relation(fields: [cariId], references: [id])

  // Manual Customer (CSV'den GÃ¶nderen/AlÄ±cÄ±)
  gonderenAdi   String
  gonderenTel   String
  gonderenEmail String?
  aliciAdi      String?
  aliciTel      String?
  aliciEmail    String?

  // Address
  teslimatAdresi String?
  il             String?
  ilce           String?
  postaKodu      String?

  // Order Details
  teslimatTuruId Int
  teslimatTuru   TeslimatTuru @relation(fields: [teslimatTuruId], references: [id])
  subeId         Int?
  sube           Sube?        @relation(fields: [subeId], references: [id])

  // Financial - BEST PRACTICE ALANLARI
  araToplam         Float @default(0) // Kalemler toplamÄ±
  kdvToplam         Float @default(0) // KDV tutarÄ±
  kargoUcreti       Float @default(0) // Kargo Ã¼creti
  digerHizmetTutari Float @default(0) // DiÄŸer hizmetler
  toplamTutar       Float @default(0) // Final tutar

  // MALÄ°YET HESAPLAMA ALANLARI - YENÄ°!
  toplamMaliyet           Float?    @default(0) // Hesaplanan toplam maliyet
  karMarji                Float?    @default(0) // Kar marjÄ± (Tutar - Maliyet)
  karOrani                Float?    @default(0) // Kar oranÄ± %
  maliyetGuncellemeTarihi DateTime? // Maliyet hesaplama tarihi

  // Status
  durum       SiparisDurumu @default(ONAY_BEKLEYEN)
  kargoDurumu KargoDurumu   @default(ADRESE_TESLIMAT)

  // Cargo Info
  kargoSirketi String?
  kargoTakipNo String?
  kargoNotu    String?
  kargoTarihi  DateTime?

  // Transfer (Åubeler arasÄ±) - YENÄ° SISTEM
  hedefSubeId   Int?
  hedefSube     Sube? @relation("HedefSube", fields: [hedefSubeId], references: [id])
  subeNeredenId Int?  // Nereden ÅŸube (ÅŸubeden ÅŸubeye transfer iÃ§in)
  subeNereyeId  Int?  // Nereye ÅŸube (ÅŸubeden ÅŸubeye transfer iÃ§in)
  subeNereden   Sube? @relation("SubeNereden", fields: [subeNeredenId], references: [id])
  subeNereye    Sube? @relation("SubeNereye", fields: [subeNereyeId], references: [id])

  // Notes
  siparisNotu  String?
  ozelTalepler String?
  dahiliNotlar String?

  // Priority
  oncelik OncelikSeviyesi @default(NORMAL)
  acilmi  Boolean         @default(false)

  // Relations
  kalemler   SiparisKalemi[]
  odemeler   CariOdeme[]
  hareketler CariHareket[]

  // Audit - KÄ°M NEYÄ° NE ZAMAN YAPTI TAKÄ°BÄ°
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       Int?
  olusturan       User?     @relation("SiparisOlusturan", fields: [createdBy], references: [id])
  onaylayanId     Int?
  onaylayan       User?     @relation("SiparisOnaylayan", fields: [onaylayanId], references: [id])
  onaylanmaTarihi DateTime?

  // PERSONEL TAKÄ°P SÄ°STEMÄ° - YENÄ°!
  lastModifiedBy       String? // Son deÄŸiÅŸtiren personelin ID'si
  lastModifiedPersonel User?     @relation("SiparisLastModifiedBy", fields: [lastModifiedBy], references: [personelId])
  lastModifiedAt       DateTime? // Son deÄŸiÅŸiklik tarihi
  lastAction           String? // Son yapÄ±lan iÅŸlem ("ONAYLANDI", "GÃœNCELLENDÄ°", vb.)

  @@index([durum])
  @@index([kargoDurumu])
  @@index([cariId])
  @@index([tarih])
  @@index([createdAt])
  @@index([toplamMaliyet]) // Maliyet sorgularÄ± iÃ§in
}

enum SiparisDurumu {
  ONAY_BEKLEYEN // SipariÅŸ alÄ±ndÄ±, onay bekleniyor
  HAZIRLLANACAK // OnaylandÄ±, hazÄ±rlanacak
  HAZIRLANDI // HazÄ±rlandÄ±, stoktan dÃ¼ÅŸÃ¼ldÃ¼
  IPTAL // Ä°ptal edildi
}

enum KargoDurumu {
  KARGOYA_VERILECEK // Kargoya verilecek
  KARGODA // Kargoda
  TESLIM_EDILDI // Teslim edildi
  SUBEYE_GONDERILECEK // Åubeye gÃ¶nderilecek  
  SUBEDE_TESLIM // Åubede teslim
  ADRESE_TESLIMAT // Adrese teslimat
  SUBEDEN_SUBEYE // Åubeden ÅŸubeye
  IPTAL // Ä°ptal
}

enum OncelikSeviyesi {
  DUSUK
  NORMAL
  YUKSEK
  ACIL
}

model SiparisKalemi {
  id        Int     @id @default(autoincrement())
  siparisId Int
  siparis   Siparis @relation(fields: [siparisId], references: [id], onDelete: Cascade)

  // Product Info
  urunId   Int
  urun     Urun    @relation(fields: [urunId], references: [id])
  urunAdi  String // Snapshot
  urunKodu String? // Snapshot

  // Quantity & Pricing
  miktar      Float
  birim       SatisBirimi
  birimFiyat  Float
  kdvOrani    Float       @default(18)
  iskonto     Float       @default(0)
  araToplam   Float // miktar * birimFiyat
  kdvTutari   Float // araToplam * kdvOrani / 100
  toplamTutar Float // araToplam + kdvTutari - iskonto

  // MALÄ°YET HESAPLAMA ALANLARI - YENÄ°!
  birimMaliyet  Float? @default(0) // Hesaplanan birim maliyet
  toplamMaliyet Float? @default(0) // Hesaplanan toplam maliyet
  karMarji      Float? @default(0) // Kar marjÄ± (kalem bazÄ±nda)
  karOrani      Float? @default(0) // Kar oranÄ± % (kalem bazÄ±nda)

  // Packaging - Sadece TepsiTava ve Kutu kullanÄ±lÄ±yor
  tepsiTavaId Int?
  tepsiTava   TepsiTava? @relation(fields: [tepsiTavaId], references: [id])
  kutuId      Int?
  kutu        Kutu?      @relation(fields: [kutuId], references: [id])

  // Production
  uretimNotu String?

  // Relations
  stokHareketleri StokHareket[]

  @@index([siparisId])
  @@index([urunId])
  @@index([birimMaliyet]) // Maliyet sorgularÄ± iÃ§in
}

// ===================================================================
// ğŸ§¾ RECIPE & COST CALCULATION (CSV Based)
// ===================================================================

model Material {
  id    Int            @id @default(autoincrement())
  ad    String         @unique
  kod   String         @unique // HM001, HM002, YM001, vb. (CSV'den)
  tipi  MaterialTipi
  birim MaterialBirimi @default(KG)

  // Pricing (CSV'den Son Fiyat)
  birimFiyat Float? @default(0)

  // Stock Info
  mevcutStok    Float  @default(0)
  minStokSeviye Float  @default(0)
  maxStokSeviye Float?
  kritikSeviye  Float  @default(10)

  // Properties
  aciklama         String?
  tedarikci        String?
  rafOmru          Int? // gÃ¼n
  saklamaKosullari String?
  aktif            Boolean @default(true)

  // Relations
  receteIcerikleri RecipeIngredient[]
  stokHareketleri  StokHareket[]
  stokTransferleri StokTransfer[]     @relation("MaterialTransfer")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // PERSONEL TAKÄ°P SÄ°STEMÄ° - YENÄ°!
  lastModifiedBy       String? // Son deÄŸiÅŸtiren personelin ID'si
  lastModifiedPersonel User?     @relation("MaterialLastModifiedBy", fields: [lastModifiedBy], references: [personelId])
  lastModifiedAt       DateTime? // Son deÄŸiÅŸiklik tarihi
  lastAction           String? // Son yapÄ±lan iÅŸlem ("FÄ°YAT_GÃœNCELLENDÄ°", "STOK_SAYIMI", vb.)

  @@index([kod])
  @@index([tipi])
  @@index([aktif])
}

enum MaterialTipi {
  HAMMADDE // HM001, HM002, vb.
  YARI_MAMUL // YM001, YM002, vb.
  YARDIMCI_MADDE
}

enum MaterialBirimi {
  KG
  GRAM
  LITRE
  ML
  ADET
  PAKET
}

model Recipe {
  id  Int    @id @default(autoincrement())
  ad  String @unique
  kod String @unique

  // Product Relation
  urunId Int?
  urun   Urun? @relation(fields: [urunId], references: [id])

  // Recipe Details
  aciklama        String?
  porsiyon        Float?  @default(1) // KaÃ§ porsiyon iÃ§in
  hazirlamaSuresi Int? // Dakika
  pisirmeSuresi   Int? // Dakika

  // Instructions
  hazirlanisi Json? // AdÄ±m adÄ±m talimatlar
  notlar      String?

  // MALÄ°YET HESAPLAMA - YENÄ°!
  toplamMaliyet    Float?    @default(0) // Hesaplanan toplam maliyet
  birimMaliyet     Float?    @default(0) // Kg baÅŸÄ±na maliyet
  guncellemeTarihi DateTime? // Son hesaplama tarihi

  // Status
  aktif    Boolean @default(true)
  test     Boolean @default(false)
  versiyon String  @default("1.0")

  // Relations
  icerikelek RecipeIngredient[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int?

  // PERSONEL TAKÄ°P SÄ°STEMÄ° - YENÄ°!
  lastModifiedBy       String? // Son deÄŸiÅŸtiren personelin ID'si
  lastModifiedPersonel User?     @relation("RecipeLastModifiedBy", fields: [lastModifiedBy], references: [personelId])
  lastModifiedAt       DateTime? // Son deÄŸiÅŸiklik tarihi
  lastAction           String? // Son yapÄ±lan iÅŸlem ("REÃ‡ETE_GÃœNCELLENDÄ°", "MALÄ°YET_HESAPLANDI", vb.)

  @@unique([urunId, versiyon])
  @@index([aktif])
  @@index([urunId])
}

model RecipeIngredient {
  id         Int      @id @default(autoincrement())
  recipeId   Int
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  materialId Int
  material   Material @relation(fields: [materialId], references: [id])

  // Quantity (CSV'den)
  miktar Float // Net Miktar
  birim  MaterialBirimi

  // Fire Calculations (CSV'den)
  fire1       Float? @default(0) // Fire oranÄ± 1 (0-1 arasÄ±)
  fire2       Float? @default(0) // Fire oranÄ± 2 (0-1 arasÄ±)
  gerMiktar   Float? @default(0) // Fire hesaplÄ± gerÃ§ek miktar
  gerMiktarTB Float? @default(0) // Talep bazÄ±nda gerÃ§ek miktar

  // Cost Calculation (CSV'den)
  sonFiyat Float? @default(0) // Material birim fiyatÄ±
  maliyet  Float? @default(0) // Hesaplanan maliyet (miktar * fiyat)

  // Instructions
  hazirlamaNotu      String? // "ince doÄŸranmÄ±ÅŸ", "kaynatÄ±lmÄ±ÅŸ"
  zorunlu            Boolean @default(true)
  alternatifOlabilir Boolean @default(false)
  siraNo             Int? // KullanÄ±m sÄ±rasÄ±

  @@unique([recipeId, materialId])
  @@index([recipeId])
  @@index([materialId])
}

// ===================================================================
// ğŸ“Š STOCK MANAGEMENT
// ===================================================================

model StokHareket {
  id Int @id @default(autoincrement())

  // Item Reference
  urunId     Int?
  urun       Urun?     @relation(fields: [urunId], references: [id])
  materialId Int?
  material   Material? @relation(fields: [materialId], references: [id])

  // Movement Details
  tip    StokHareketTipi
  miktar Float
  birim  String

  // Financial Impact
  birimMaliyet  Float? @default(0) // Hareket anÄ±ndaki maliyet
  toplamMaliyet Float? @default(0) // Toplam maliyet etkisi

  // Reference Documents
  siparisKalemiId Int?
  siparisKalemi   SiparisKalemi? @relation(fields: [siparisKalemiId], references: [id])
  transferId      Int?
  transfer        StokTransfer?  @relation(fields: [transferId], references: [id])

  // Additional Info
  aciklama   String?
  referansNo String? // FiÅŸ no, fatura no

  // Stock Levels
  oncekiStok  Float?
  sonrakiStok Float?

  // Audit
  createdAt DateTime @default(now())
  createdBy Int?
  user      User?    @relation(fields: [createdBy], references: [id])

  @@index([tip])
  @@index([urunId])
  @@index([materialId])
  @@index([createdAt])
}

enum StokHareketTipi {
  GIRIS
  CIKIS
  TRANSFER
  FIRE
  SAYIM_FAZLA
  SAYIM_EKSIK
  URETIM_GIRDI
  URETIM_CIKTI
  IADE
  DUZELTME
}

model StokTransfer {
  id         Int    @id @default(autoincrement())
  transferNo String @unique @default(uuid())

  // Transfer Details
  kaynakSubeId Int?
  kaynakSube   Sube? @relation("KaynakSube", fields: [kaynakSubeId], references: [id])
  hedefSubeId  Int?
  hedefSube    Sube? @relation("HedefSube", fields: [hedefSubeId], references: [id])

  // Items
  urunId     Int?
  urun       Urun?     @relation("UrunTransfer", fields: [urunId], references: [id])
  materialId Int?
  material   Material? @relation("MaterialTransfer", fields: [materialId], references: [id])

  miktar   Float
  birim    String
  aciklama String?

  // Cost Tracking
  birimMaliyet  Float? @default(0)
  toplamMaliyet Float? @default(0)

  // Status
  durum          TransferDurumu @default(BEKLIYOR)
  gonderimTarihi DateTime?
  teslimTarihi   DateTime?

  // Relations
  stokHareketleri StokHareket[]

  // Audit
  createdAt    DateTime @default(now())
  createdBy    Int?
  olusturan    User?    @relation("StokTransferOlusturan", fields: [createdBy], references: [id])
  gonderenId   Int?
  gonderen     User?    @relation("StokTransferGonderen", fields: [gonderenId], references: [id])
  teslimAlanId Int?
  teslimAlan   User?    @relation("StokTransferTeslimAlan", fields: [teslimAlanId], references: [id])

  @@index([durum])
  @@index([kaynakSubeId])
  @@index([hedefSubeId])
}

enum TransferDurumu {
  BEKLIYOR
  GONDERILDI
  TESLIM_ALINDI
  IPTAL
}

// ===================================================================
// ğŸ’³ FINANCIAL MANAGEMENT (CSV Based)
// ===================================================================

model CariHareket {
  id     Int  @id @default(autoincrement())
  cariId Int
  cari   Cari @relation(fields: [cariId], references: [id])

  // Transaction Details
  tip      HareketTipi
  tutar    Float
  aciklama String?

  // Document Reference
  siparisId Int?
  siparis   Siparis?   @relation(fields: [siparisId], references: [id])
  odemeId   Int?
  odeme     CariOdeme? @relation(fields: [odemeId], references: [id])

  // Document Info
  belgeNo     String?
  belgeTarihi DateTime? @db.Date

  // Balance Tracking
  oncekiBakiye  Float?
  sonrakiBakiye Float?

  // Audit
  createdAt DateTime @default(now())
  createdBy Int?
  user      User?    @relation(fields: [createdBy], references: [id])

  @@index([cariId])
  @@index([tip])
  @@index([createdAt])
}

enum HareketTipi {
  BORC
  ALACAK
  VIRMAN
}

model CariOdeme {
  id     Int  @id @default(autoincrement())
  cariId Int
  cari   Cari @relation(fields: [cariId], references: [id])

  // Payment Details
  tutar        Float
  odemeYontemi OdemeYontemi
  aciklama     String?

  // Document Reference  
  siparisId Int?
  siparis   Siparis? @relation(fields: [siparisId], references: [id])

  // Payment Info
  odemeTarihi DateTime  @db.Date
  vadeTarihi  DateTime? @db.Date

  // Bank/Check Info
  bankaAdi  String?
  hesapNo   String?
  cekNo     String?
  cekTarihi DateTime? @db.Date

  // Status
  durum OdemeDurumu @default(ODENDI)

  // Relations
  hareketler CariHareket[]

  // Audit
  createdAt DateTime @default(now())
  createdBy Int?
  user      User?    @relation(fields: [createdBy], references: [id])

  @@index([cariId])
  @@index([odemeYontemi])
  @@index([durum])
  @@index([odemeTarihi])
}

enum OdemeYontemi {
  NAKIT // OY001 (CSV'den)
  KREDI_KARTI // OY002
  CARI // OY003
  CEK // OY004
  BANKA_HAVALESI // OY005
  IKRAM // OY006
}

enum OdemeDurumu {
  ODENDI
  BEKLIYOR
  GECIKTI
  IPTAL
}

// ===================================================================
// ğŸ“ AUDIT & LOGGING SYSTEM
// ===================================================================

model AuditLog {
  id Int @id @default(autoincrement())

  // Kim yaptÄ±?
  personelId String
  personel   User   @relation("PersonelAuditLogs", fields: [personelId], references: [personelId])

  // Neyi yaptÄ±?
  action    AuditAction // CREATE, UPDATE, DELETE, APPROVE, CANCEL, vb.
  tableName String // "Siparis", "Urun", "Material", vb.
  recordId  String // DeÄŸiÅŸtirilen kaydÄ±n ID'si

  // Ne deÄŸiÅŸtirdi?
  oldValues   Json? // Eski deÄŸerler (UPDATE iÃ§in)
  newValues   Json? // Yeni deÄŸerler (CREATE/UPDATE iÃ§in)
  description String? // "SipariÅŸ onaylandÄ±", "ÃœrÃ¼n fiyatÄ± gÃ¼ncellendi", vb.

  // Sistem bilgileri
  ipAddress String?
  userAgent String?
  sessionId String?

  // Timing
  timestamp DateTime @default(now())

  @@index([personelId])
  @@index([tableName])
  @@index([recordId])
  @@index([timestamp])
  @@index([action])
}

enum AuditAction {
  // CRUD Operations
  CREATE
  UPDATE
  DELETE

  // Business Actions
  APPROVE // SipariÅŸ onaylama
  CANCEL // SipariÅŸ iptal
  COMPLETE // SipariÅŸ tamamlama
  TRANSFER // Stok transfer
  PAYMENT // Ã–deme

  // Login/Security
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  PERMISSION_CHANGE

  // Bulk Operations
  BULK_UPDATE
  BULK_DELETE
  IMPORT
  EXPORT
}

// ===================================================================
// âš™ï¸ SYSTEM SETTINGS
// ===================================================================

model SystemSetting {
  id          Int             @id @default(autoincrement())
  key         String          @unique
  value       String
  dataType    SettingDataType @default(STRING)
  category    String?
  description String?
  updatedAt   DateTime        @updatedAt
  updatedBy   Int?
}

enum SettingDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}
