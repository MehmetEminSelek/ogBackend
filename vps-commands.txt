# =================================================================
# ðŸš€ VPS'te Ã‡alÄ±ÅŸtÄ±rÄ±lacak Komutlar (SÄ±rayla)
# SSH'la baÄŸlandÄ±ktan sonra bu komutlarÄ± kopyala-yapÄ±ÅŸtÄ±r
# =================================================================

# 1. Script dosyasÄ± oluÅŸtur
cat > hostinger-full-deploy.sh << 'SCRIPT_EOF'
#!/bin/bash
# =================================================================
# ðŸš€ OG SÄ°PARÄ°Åž - HOSTÄ°NGER VPS FULL DEPLOYMENT SCRIPT
# Backend + Frontend + PostgreSQL + Nginx + SSL
# =================================================================

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸš€ OG SipariÅŸ Hostinger VPS Deployment BaÅŸlÄ±yor...${NC}"

# Configuration
PROJECT_NAME="og-siparis"
BACKEND_DIR="/var/www/og-backend" 
FRONTEND_DIR="/var/www/og-frontend"
DOMAIN=${1:-"ogsiparis.com"}
DB_NAME="ogformdb"
DB_PASS=${2:-"$(openssl rand -base64 32)"}

echo -e "${YELLOW}ðŸ“‹ KonfigÃ¼rasyon:${NC}"
echo "Domain: $DOMAIN"
echo "Backend: $BACKEND_DIR"
echo "Frontend: $FRONTEND_DIR"
echo "Database: $DB_NAME"

# =================================================================
# 1. SYSTEM UPDATE & DEPENDENCIES
# =================================================================
echo -e "${BLUE}ðŸ“¦ Sistem gÃ¼ncelleniyor ve gerekli paketler kuruluyor...${NC}"

apt update && apt upgrade -y
apt install -y curl wget git nginx postgresql postgresql-contrib ufw fail2ban

# =================================================================
# 2. NODE.JS INSTALLATION
# =================================================================
echo -e "${BLUE}ðŸ“¦ Node.js kuruluyor...${NC}"

curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# PM2 kurulumu
npm install -g pm2

# VersiyonlarÄ± kontrol et
node --version
npm --version
pm2 --version

# =================================================================
# 3. POSTGRESQL SETUP
# =================================================================
echo -e "${BLUE}ðŸ—„ï¸ PostgreSQL yapÄ±landÄ±rÄ±lÄ±yor...${NC}"

systemctl start postgresql
systemctl enable postgresql

# Database ve kullanÄ±cÄ± oluÅŸtur
sudo -u postgres psql << EOF
CREATE DATABASE $DB_NAME;
CREATE USER ogform WITH ENCRYPTED PASSWORD '$DB_PASS';
ALTER ROLE ogform SET client_encoding TO 'utf8';
ALTER ROLE ogform SET default_transaction_isolation TO 'read committed';
ALTER ROLE ogform SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO ogform;
\q
EOF

echo -e "${GREEN}âœ… PostgreSQL kuruldu - DB: $DB_NAME, User: ogform${NC}"

# =================================================================
# 4. BACKEND DEPLOYMENT
# =================================================================
echo -e "${BLUE}ðŸ”§ Backend deploy ediliyor...${NC}"

# Backend klasÃ¶rÃ¼nÃ¼ oluÅŸtur
mkdir -p $BACKEND_DIR
cd $BACKEND_DIR

# GitHub'dan backend'i klonla
if [ ! -d ".git" ]; then
    git clone https://github.com/MehmetEminSelek/ogBackend.git .
else
    git pull origin main
fi

# Dependencies kur
npm install

# Production .env oluÅŸtur
cat > .env << EOF
# OG Backend API - Production Environment
NODE_ENV=production
PORT=3000

# Database Configuration
DATABASE_URL="postgresql://ogform:$DB_PASS@localhost:5432/$DB_NAME?schema=public"

# JWT Secret
JWT_SECRET="og-siparis-super-secret-jwt-key-production-$(date +%s)"

# API Domain Configuration  
NEXT_PUBLIC_API_URL=https://$DOMAIN/api
CORS_ORIGIN=https://$DOMAIN

# Email Configuration (Hostinger SMTP)
SMTP_HOST=smtp.hostinger.com
SMTP_PORT=587
SMTP_USER=admin@$DOMAIN
SMTP_PASS=your-email-password

# File Upload
MAX_FILE_SIZE=10MB
UPLOAD_DIR=./uploads

# Security
BCRYPT_ROUNDS=12
EOF

# Prisma generate ve migrate
npx prisma generate
npx prisma db push

# Build project
npm run build

echo -e "${GREEN}âœ… Backend hazÄ±r!${NC}"

# =================================================================
# 5. FRONTEND DEPLOYMENT  
# =================================================================
echo -e "${BLUE}ðŸŽ¨ Frontend deploy ediliyor...${NC}"

# Frontend klasÃ¶rÃ¼nÃ¼ oluÅŸtur
mkdir -p $FRONTEND_DIR
cd $FRONTEND_DIR

# GitHub'dan frontend'i klonla
if [ ! -d ".git" ]; then
    git clone https://github.com/MehmetEminSelek/ogFrontend.git .
else
    git pull origin main
fi

# Dependencies kur
npm install

# Production .env oluÅŸtur
cat > .env.production << EOF
NEXT_PUBLIC_API_URL=https://$DOMAIN/api
NEXT_PUBLIC_SITE_URL=https://$DOMAIN
NODE_ENV=production
EOF

# Build project
npm run build

echo -e "${GREEN}âœ… Frontend hazÄ±r!${NC}"

# =================================================================
# 6. PM2 CONFIGURATION
# =================================================================
echo -e "${BLUE}âš™ï¸ PM2 yapÄ±landÄ±rÄ±lÄ±yor...${NC}"

# Backend PM2 baÅŸlat
cd $BACKEND_DIR
pm2 start ecosystem.config.js --env production

# Frontend PM2 baÅŸlat  
cd $FRONTEND_DIR
pm2 start npm --name "og-frontend" -- start -- -p 5173

# PM2 kaydet ve startup
pm2 save
pm2 startup

echo -e "${GREEN}âœ… PM2 Ã§alÄ±ÅŸÄ±yor!${NC}"

# =================================================================
# 7. NGINX CONFIGURATION
# =================================================================
echo -e "${BLUE}ðŸŒ Nginx yapÄ±landÄ±rÄ±lÄ±yor...${NC}"

# Nginx konfigÃ¼rasyonu
cat > /etc/nginx/sites-available/$DOMAIN << EOF
server {
    listen 80;
    server_name $DOMAIN www.$DOMAIN;

    # Frontend (Ana sayfa)
    location / {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }

    # Backend API
    location /api/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }

    # Static files
    location /_next/static/ {
        proxy_pass http://localhost:5173;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# Nginx site'Ä± aktifleÅŸtir
ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# Nginx test ve restart
nginx -t
systemctl restart nginx

echo -e "${GREEN}âœ… Nginx yapÄ±landÄ±rÄ±ldÄ±!${NC}"

# =================================================================
# 8. FIREWALL CONFIGURATION
# =================================================================
echo -e "${BLUE}ðŸ”’ Firewall yapÄ±landÄ±rÄ±lÄ±yor...${NC}"

ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 'Nginx Full'
ufw --force enable

echo -e "${GREEN}âœ… Firewall aktif!${NC}"

# =================================================================
# 9. SSL CERTIFICATE (Let's Encrypt)
# =================================================================
echo -e "${BLUE}ðŸ” SSL sertifikasÄ± kuruluyor...${NC}"

# Certbot kur
apt install -y certbot python3-certbot-nginx

# SSL sertifikasÄ± al
certbot --nginx -d $DOMAIN -d www.$DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN

# Otomatik yenileme
echo "0 3 * * * certbot renew --quiet" | crontab -

echo -e "${GREEN}âœ… SSL kuruldu!${NC}"

# =================================================================
# 10. DEPLOYMENT INFO
# =================================================================
echo -e "${GREEN}ðŸŽ‰ DEPLOYMENT TAMAMLANDI!${NC}"
echo -e "${YELLOW}ðŸ“‹ Bilgiler:${NC}"
echo "Website: https://$DOMAIN"
echo "API: https://$DOMAIN/api"
echo "Database: $DB_NAME (User: ogform)"
echo ""
echo -e "${YELLOW}ðŸ”§ YÃ¶netim KomutlarÄ±:${NC}"
echo "PM2 durumu: pm2 list"
echo "PM2 loglarÄ±: pm2 logs"
echo "Nginx test: nginx -t"
echo "SSL yenile: certbot renew"
echo ""
echo -e "${YELLOW}ðŸ“ KlasÃ¶rler:${NC}"
echo "Backend: $BACKEND_DIR"
echo "Frontend: $FRONTEND_DIR"
echo ""
echo -e "${GREEN}âœ… Siteniz hazÄ±r: https://$DOMAIN${NC}"
SCRIPT_EOF

# 2. Script'i Ã§alÄ±ÅŸtÄ±rÄ±labilir yap
chmod +x hostinger-full-deploy.sh

# 3. Deployment'Ä± baÅŸlat
./hostinger-full-deploy.sh ogsiparis.com 